name: Run Tests

on: [push]

jobs:
    tests:
        name: Run Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: setup php
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.1'
                extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, mysql, pdo_mysql_ bcmath, soap, intl, gd, exif, iconv
                coverage: none

            - name: Run composer install
              run: composer install -n --prefer-dist

            - name: Prepare Laravel Application
              run: |
                  cp .env.example .env
                  php artisan key:generate

            - name: Run PHPStan
              run: ./vendor/bin/phpstan --error-format=github

            - name: Create env
              run: php -r "file_exists(.env) || copy ('.env.example', .env)"

            - name: Generate env key
              run: php artisan key:generate

            - name: Create Database
              run: |
                mkdir -p database
                touch database/database.sqlite
            - name: Migrate
              run: php artisan migrate --seed

            - name: Feature Test
              env:
                DB_CONNECTION: sqlite
                DB_DATABASE: database/database.sqlite
              run: php artisan test
